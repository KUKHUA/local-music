<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>local-player</title>

        <link rel="stylesheet" href="../lib/bulma.min.css">
        <link rel="stylesheet" href="../assets/css/index.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"/>

        <script src="../assets/script/util.js"></script>

        <!--<script src="radio.js"></script>-->
        <script>
            class uiManager{
                constructor(radioStationDisplay,radioPlayer){
                    //this.radioStationDisplay = document.getElementById(radioStationDisplay);
                    //this.radioPlayer = document.getElementById(radioPlayer);
                    this.fsStore = new OPFSFileSystem('radio');
                }

                async init(){
                    await this.fsStore.init();
                    this.radioScanner = new radioScanner(this.fsStore);
                    await this.radioScanner.init();
                    this.radioTuner = new radioTuner();
                    await this.radioTuner.playStream(await this.radioScanner.getRandomStation().url,this.updateMetadata);
                }

                updateMetadata(metadata){
                    console.log(metadata);
                }
            }

            class radioTuner{
                constructor(){
                    this.audio = new Audio();
                    this.hlsAPI = new Hls();
                }

                async playStream(streamURL,metadataCallback){
                    if(Hls.isSupported()){
                        this.hlsAPI.loadSource(streamURL);
                        this.hlsAPI.attachMedia(this.audio);
                        this.hlsAPI.on(Hls.Events.MANIFEST_PARSED, function(){
                            this.audio.play();
                        });
                        this.hlsAPI.on(Hls.Events.LEVEL_LOADED, function(event,data){
                            metadataCallback(data.details);
                        });

                        if(metadataCallback){
                            hls.on(Hls.Events.FRAG_PARSING_METADATA, (event, data) => {
                                console.log(data,event);
                                if (data) {
                                    metadataCallback(data);
                                }
                            });
                        }

                    } else {
                        alert('HLS not supported');
                    }
                }
            }

            class radioScanner{
                constructor(fsStore){
                    if(!fsStore)
                        throw new Error('No file system store provided');
                    this.fsStore = fsStore;
                    this.serverList = [];
                    this.server = null;
                }

                async init(){
                    if(!await this.fsStore.hasFile('stations.json')){
                        await this.downloadStations();
                    } else {
                        this.stations = await this.fsStore.getFile('stations.json');
                        this.stations = await this.stations.getBlob();
                        this.stations = JSON.parse(await this.stations.text());
                        log(`Stations loaded from storage, ${this.stations.length} stations found`);
                        await this.getServer();
                    }
                }

                async getServer(){
                    try {
                        this.serverList = await fetch("https://de1.api.radio-browser.info/json/servers")
                        this.serverList = await this.serverList.json();
                        this.server = new URL(`https://`+this.serverList[Math.floor(Math.random() * this.serverList.length)].name);
                    } catch (e) {
                        log(`Error selecting server: ${e.message}`);
                    }
                    return this.server;
                }
                
                async downloadStations(){
                    await this.getServer();
                    log(`Selected server: ${this.server}`);
                    let testFetch = await fetch(this.server);
                    if(!testFetch.ok)
                        throw new Error(`Failed to connect to server: ${testFetch.statusText}`);

                    this.stations = await fetch(new URL('json/stations/search?limit=15',this.server));
                    if(!this.stations.ok)
                        throw new Error(`Failed to fetch stations: ${stations.statusText}`);
                    this.stations = await this.stations.json();
                    this.fsStore.createFile('stations.json',new Blob([JSON.stringify(this.stations)],{type: 'application/json'}));
                    log(`Stations downloaded and saved`);
                }

                async saveStations(){
                    if(!this.stations)
                        throw new Error('No stations to save');
                    this.fsStore.createFile('stations.json',new Blob([JSON.stringify(this.stations)],{type: 'application/json'}));
                    log(`${this.stations.length} stations saved`);
                }

                async searchStation(query){
                    if(!this.server)
                        await this.getServer();
                    let search = await fetch(new URL(`json/stations/search?name=${query}&limit=10`,this.server));
                    if(!search.ok) throw new Error(`Failed to search for stations: ${search.statusText}`);
                    return await search.json();
                }

                async addStation(name,streamURL,icon){
                    //name, url, favicon
                    if(!this.stations)
                        throw new Error('No stations loaded');
                    this.stations.push({name: name, url: streamURL, favicon: icon});
                    await this.saveStations();
                }

                async getRandomStation(){
                    if(!this.stations)
                        throw new Error('No stations loaded');
                    return this.stations[Math.floor(Math.random() * this.stations.length)];
                }
            }
        </script>

        <script src="../lib/hls.min.js"></script>
        <script src="../lib/filelib.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                window.uiManager = new uiManager('radioList', 'radioPlayer');
                window.uiManager.init();
            });
        </script>

    </head>
    <body>
        <div class="navbar-menu has-background-black p-2 is-active" style="border-radius: 1em;">
            <div class="navbar-start is-hidden-mobile">
                <h1 class="title is-2 ml-3 mt-1">local-player</h1>
            </div>

            <div>

                <button style="border-radius: 1em;" class="button has-text-grey-lighter is-size-5
                has-background-grey-darker mx-2 is-responsive has-hover" onclick="goTo('../player/');">
                    <a class="material-symbols-outlined mr-1">music_note</a> Player
                </button>

                <button style="border-radius: 1em;" class="button has-text-grey-lighter is-size-5
                has-background-grey-dark mx-2 is-responsive is-active has-hover" onclick="goTo('../radio/');">
                    <a class="material-symbols-outlined mr-1">radio</a> Radio
                </button>

            </div>


            <div class="navbar-end">

            </div>
        </div>

        <section class="section">
                <div class="container">
                    <div class="columns is-centered">

                        <div id="radioList" class="column is-half box mx-2 scroll-container" style="height: 70vh; width: 20vw;">
                            <div class="box">
                                <h2 class="title is-4">Station 1</h2>
                                <p class="subtitle is-6">Genre: Pop</p>
                                <button class="button is-primary">Play</button>
                            </div>
                            <div class="box">
                                <h2 class="title is-4">Station 2</h2>
                                <p class="subtitle is-6">Genre: Rock</p>
                                <button class="button is-primary">Play</button>
                            </div>
                            <div class="box">
                                <h2 class="title is-4">Station 3</h2>
                                <p class="subtitle is-6">Genre: Jazz</p>
                                <button class="button is-primary">Play</button>
                            </div>
                            <div class="box">
                                <h2 class="title is-4">Station 4</h2>
                                <p class="subtitle is-6">Genre: Classical</p>
                                <button class="button is-primary">Play</button>
                            </div>
                            <div class="box">
                                <h2 class="title is-4">Station 5</h2>
                                <p class="subtitle is-6">Genre: Hip-Hop</p>
                                <button class="button is-primary">Play</button>
                            </div>

                            <button class="button mx-2 is-responsive has-hover is-primary scroll-with">
                                <a class="material-symbols-outlined mr-1 has-text-primary-dark">add</a>
                            </button>
                        </div>

                        <div id="radioPlayer" class="column is-half box mx-2" style="height: 70vh; min-width: 45vw;">

                        </div>      

                    </div> 
                </div>
        </section>

        <footer class="footer has-background-black mt-6">
            <div class="content has-text-centered has-text-grey-lighter">
              <p>
                <strong class="has-text-grey-lighter">Local Music Player</strong>
                <a href="https://github.com/KUKHUA/local-music" class="has-text-info">
                  <span class="material-symbols-outlined" style="vertical-align: middle;">code</span>
                  GitHub
                </a>
              </p>
              <p>
                Built with <a href="https://bulma.io" class="has-text-info">Bulma</a> 
                (<a href="https://github.com/jgthms/bulma/blob/master/LICENSE" class="has-text-info">MIT</a>) and 
                <a href="https://github.com/aadsm/jsmediatags" class="has-text-info">JSMediaTags</a>
                (<a href="https://github.com/aadsm/jsmediatags/blob/master/LICENSE" class="has-text-info">BSD-3</a>)
              </p>
            </div>
          </footer>
    </body>
</html>